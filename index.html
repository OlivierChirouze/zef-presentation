<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>How to build a mobile app to not get rich and famous</title>
            <style>
                body, html {
                    margin: 0;
                    padding: 0;
                    height: 100%;
                    overflow: hidden;
                }
                iframe {
                    border: none;
                    position: absolute;
                    transition: opacity 0.5s ease-in-out; /* Add smooth transition for opacity */
                }
                .fullscreen {
                    width: 100%;
                    height: 100%;
                    z-index: 1;
                }
                .small {
                    width: 10%;
                    height: 10%;
                    bottom: 4px;
                    left: 4px;
                    z-index: 2;
                }
                #small-overlay {
                    background-color: transparent;
                    cursor: pointer;
                    position: absolute;
                    z-index: 3;
                }
            </style>
        </head>
        <body>
            <iframe id="slides" src="slides.html"></iframe>
            <iframe id="timeline" src="timeline-presentation/timeline.sozi.html"></iframe>
            <div class="small" id="small-overlay"></div>

            <script>
                const slides = document.getElementById('slides');
                const timeline = document.getElementById('timeline');

                /**
                 * Set the state of the slides and timeline iframes.
                 * @param {boolean} isSlidesFullscreen - If true, set the slides iframe to fullscreen; otherwise, set it to small.
                 * @returns {HTMLElement} - Returns the slides iframe.
                 */
                function setState(isSlidesFullscreen) {
                    setIframeSize(slides, !isSlidesFullscreen);
                    setIframeSize(timeline, isSlidesFullscreen);
                }

                /**
                 * Toggle the size of the slides and timeline iframes.
                 */
                function toggleFrames() {
                    console.debug("toggleFrames");
                    const isSlidesFullscreen = isIframeFullscreen(slides);
                    setState(isSlidesFullscreen);
                }

                /**
                 * Check if an iframe is in fullscreen mode.
                 * @param {HTMLElement} iframe - The iframe element to check.
                 * @returns {boolean} - Returns true if the iframe is in fullscreen mode, otherwise false.
                 */
                function isIframeFullscreen(iframe) {
                    return iframe.classList.contains('fullscreen');
                }

                /**
                 * Set the size of an iframe to either small or fullscreen.
                 * @param {HTMLIFrameElement} iframe - The iframe element to resize.
                 * @param {boolean} fullscreen - If true, set to fullscreen; otherwise, set to small.
                 */
                function setIframeSize(iframe, fullscreen) {
                    if (fullscreen) {
                        iframe.classList.add('fullscreen');
                        iframe.classList.remove('small');
                        iframe.focus();

                        if (iframe === slides) {
                            // show controls
                            iframe.contentDocument.querySelector(".controls").style.display = "block";
                        } else {
                            // Show the "mask" layer
                            iframe.contentDocument.querySelector("#mask").style.display = "block";
                        }

                    } else {
                        iframe.classList.add('small');
                        iframe.classList.remove('fullscreen');

                        if (iframe === slides) {
                            // hide controls
                            iframe.contentDocument.querySelector(".controls").style.display = "none";
                        } else {
                            // Hide the "mask" layer
                            iframe.contentDocument.querySelector("#mask").style.display = "none";
                        }
                    }
                }

                /**
                 * Show the given iframe by setting its display to 'block'.
                 * @param {HTMLIFrameElement} iframe - The iframe element to show.
                 */
                function showIframe(iframe) {
                    console.debug("showIframe", iframe);
                    iframe.style.opacity = 1;
                }

                /**
                 * Hide the given iframe by setting its display to 'none'.
                 * @param {HTMLIFrameElement} iframe - The iframe element to hide.
                 */
                function hideIframe(iframe) {
                    console.debug("hideIframe", iframe);
                    iframe.style.opacity = 0;
                }

                // Init -----------------------------------------------------------------------------------

                // Make small iframe "clickable" to toggle via transparent layer
                document.getElementById('small-overlay').addEventListener('click', () => toggleFrames());

                // Event configuration ---------------------------------------------
                const toggleKey = 'y';

                // Event listener for keydown event to toggle frames
                window.addEventListener('keydown', function(event) {
                    if (event.key === toggleKey) {
                        toggleFrames();
                    }
                });

                // Event listener for message event to toggle frames
                window.addEventListener('message', function(event) {
                    if (event.data === 'toggleFrames') {
                        toggleFrames();
                    }
                });

                // Add event listener to each iframe to listen for keydown event
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    iframe.contentWindow.addEventListener('keydown', function(event) {
                        if (event.key === toggleKey) {
                            console.debug("keyboard event t");
                            window.postMessage('toggleFrames', '*');
                        }
                    });
                });

                // Initially, hide timeline. It will be shown for first section with data-show-timeline
                hideIframe(timeline);

                // -----------------------------------------------------------------
                let reveal = null;
                let sozi = null;

                slides.onload = (e) => {
                    const myWindow = e.target.contentWindow;
                    reveal = myWindow.Reveal;

                    setState(false);

                    const updateMainWindowHash = () => {
                        const currentHash = reveal.getSlidePath();
                        if (currentHash) {
                            history.replaceState(null, '', `#${currentHash}`);
                        }
                    }

                    // when entering a particular slide, if it has an id, try to move the sozi player to that frame
                    reveal.addEventListener('slidechanged', (e) => {

                        // Sync the main page URL with the slides iframe anchor
                        updateMainWindowHash();

                        // -------------- Sync from presentation to timeline
                        const section = e.currentSlide;
                        const id = section.id;

                        const isHideTimeline = section.attributes["data-hide-timeline"] !== undefined;

                        if (isHideTimeline) {
                            hideIframe(timeline);
                        } else {
                            showIframe(timeline);
                        }

                        console.debug("reveal event: slidechanged", section);
                        if (id) {
                            moveToFrame(id);
                        }
                    });

                    reveal.addEventListener('fragmentshown', () => updateMainWindowHash());
                    reveal.addEventListener('fragmenthidden', () => updateMainWindowHash());
                };

                // Append the main page anchor to the slides iframe src on page load
                window.addEventListener('load', () => {
                    const currentHash = window.location.hash;
                    if (currentHash) {
                        slides.src = `slides.html${currentHash}`;
                    }
                });

                function moveToSlide(slideId) {
                    // Only if we can identify the corresponding slide
                    const section = slides.contentDocument.getElementById(slideId);
                    if (section) {
                        console.debug("move to slide ", slideId);
                        const indices = reveal.getIndices(section);
                        reveal.slide(indices.h, indices.v);
                    }
                }

                function moveToFrame(slideId) {
                    // FIXME make sure the frame exists, otherwise ignore
                    console.debug("sozi.moveToFrame", slideId);
                    if (sozi.playerController.player.findFrame(slideId) != null)
                        sozi.playerController.moveToFrame(slideId);
                }

                // Configure the sync between timeline and slides
                timeline.onload = (e) => {
                    const contentWindow = e.target.contentWindow;
                    sozi = contentWindow.sozi;

                    // Make each commit clickable
                    const svg = contentWindow.document.querySelector('svg');

                    // -------------- Sync from timeline to presentation
                    if (svg) {
                        const textElements = svg.querySelectorAll('text');
                        textElements.forEach(textElement => {
                            // When clicking a particular commit on the timeline,
                            // navigate the presentation to the corresponding slide
                            // FIXME first make sure the slide exists on slides?
                            textElement.addEventListener('click', () => {
                                const slideId = textElement.innerHTML;
                                moveToSlide(slideId);
                                toggleFrames();
                                // Also, try to re-align sozy frame
                                moveToFrame(slideId);
                            });
                            textElement.style.cursor = 'pointer';
                        });
                    }

                    // When the timeline presentation moves to a particular frame, try to sync the slides
                    sozi.playerController.addListener("moveToFrame", (f) => {
                        if (f == null)
                            return;
                        console.debug("sozi event: moveToFrame", f);
                        moveToSlide(f.frameId);
                    })
                };
            </script>
        </body>
        </html>
